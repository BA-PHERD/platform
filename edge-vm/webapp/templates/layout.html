<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>BA-PHERD - {% block title %}{% endblock %}</title>
    <link href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css" rel="stylesheet">
    <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
    <script src="{{ url_for('static', filename='utils.js') }}"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="top-right-form">
        <form id="login-form" data-login-step="change">
            <label>
                Group Name<br>
                <input type="text" id="group-name" name="group_name"
                       value="{{ group_name }}" readonly required minlength="1">
            </label><br>
            <label>
                Username<br>
                <input type="text" id="username" name="username"
                       value="{{ username }}" readonly required minlength="1">
            </label><br>
            <button type="submit" class="pretty-button" id="login-submit-btn">Modifica</button>
        </form>
        <div id="login-message" class="message"></div>
    </div>

    <header class="mdc-top-app-bar mdc-top-app-bar--short">
        <div class="mdc-top-app-bar__row">
            <section class="mdc-top-app-bar__section mdc-top-app-bar__section--align-start">
                <button class="material-icons mdc-top-app-bar__navigation-icon mdc-icon-button">menu</button>
                <span class="mdc-top-app-bar__title">Title</span>
            </section>
            <section class="mdc-top-app-bar__section mdc-top-app-bar__section--align-end" role="toolbar">
                <button class="material-icons mdc-top-app-bar__action-item mdc-icon-button" aria-label="Bookmark this page">bookmark</button>
            </section>
        </div>
    </header>
    <main class="mdc-top-app-bar--short-fixed-adjust">
        App content
    </main>

    <div class="container">
        {% block container_content %}{% endblock %}
    </div>

    {% block js %}{% endblock %}

    <script>
        const group = document.getElementById('group-name');
        const user  = document.getElementById('username');
        const loginMessage = document.getElementById('login-message');
        const loginSubmitBtn = document.getElementById('login-submit-btn');
        const loginForm = document.getElementById('login-form');
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            if (loginForm.dataset.loginStep === 'change') {
                group.readOnly = false;
                user.readOnly = false;
                loginSubmitBtn.textContent = 'Login'
                loginForm.dataset.loginStep = 'login';

                return;
            }
            
            loginSubmitBtn.disabled = true;
            group.readOnly = true;
            user.readOnly = true;
            loginSubmitBtn.textContent = 'Modifica'
            loginForm.dataset.loginStep = 'change';

            fetch("{{ url_for('users.login_user') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ group_name: group.value, username: user.value })
            })
            .then(res => {
                console.log(res);

                if (res.ok) {
                    showMsg(loginMessage, `Login con utente ${group.value}:${user.value}`, 'success');
                } 
                else {
                    throw new Error(`The response returned status ${res.status}`);
                }
            })
            .catch(err => {
                showMsg(loginMessage, 'Si Ã¨ verificato un errore', 'error');
                console.error(err);
            })
            .then(_ => {
                loginSubmitBtn.disabled = false;
            });
        });
    </script>
</body>
</html>
