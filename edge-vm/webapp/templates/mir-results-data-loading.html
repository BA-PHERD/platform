{% extends "layout.html" %}
{% block title %}Caricamento risultati analisi{% endblock %}
{% block common_css %}
    {{ super() }}
{% endblock %}
{% block container_content %}
    <h2>Carica i risultati dell'analisi MiR</h2>
    <form id="uploadForm" enctype="multipart/form-data">
        <input class="pretty-button" type="file" id="fileInput" accept=".xls,.xlsx,.odt" required>
        <button class="pretty-button" id="submit-file-btn" type="submit">Invia</button>
    </form>
    <div id="message" class="message"></div>
{% endblock %}
{% block js %}
<script>
    const fileInput = document.getElementById('fileInput');
    const messageDiv = document.getElementById('message');
    const submitBtn = document.getElementById('submit-file-btn');
    document.getElementById('uploadForm').addEventListener('submit', function (event) {
        submitBtn.disabled = true;

        if (fileInput.files.length === 0) {
            showMessage('Non hai caricato alcun file', 'error');
            return;
        }

        const file = fileInput.files[0];
        if (!file.name.match(/\.(xls|xlsx|odt)$/)) {
            showMessage('Il tipo di file non è valido. File compatibili: .xls,.xlsx,.odt', 'error');
            return;
        }

        const formData = new FormData();
        formData.append('data_file', file);

        fetch("{{ url_for('mir-results-data-loading.load_from_excel') }}", {
            method: 'POST',
            body: formData
        })
        .then(res => {
            submitBtn.disabled = false;
            console.log(res);

            if (res.ok) {
                showMessage('File caricato correttamente', 'success');
            }
            else {
                throw new Error(`The response returned status ${res.status}`);
            }
        })
        .catch(error => {
            submitBtn.disabled = false;
            showMessage('Si è verificato un errore', 'error');
            console.error(error);
        });
    });

    function showMessage(text, type) {
        messageDiv.textContent = text;
        messageDiv.className = `message ${type}`;

        fileInput.value = ''

        setTimeout(() => {
            messageDiv.textContent = ''
            messageDiv.className = 'message';
        }, 10000)
    }
</script>
{% endblock %}